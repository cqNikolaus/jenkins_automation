pipeline {
    agent {
        docker {
            image 'python-build'
            args '-u root:root'
        }
    }
    environment {
        API_TOKEN = credentials('HETZNER_API_TOKEN')
        DNS_API_TOKEN = credentials('HETZNER_DNS_API_TOKEN')
        DOMAIN = "jenkins-${env.BUILD_NUMBER}.comquent.academy" 
        ZONE_NAME = "comquent.academy"
        SSH_KEY_NAME = 'AzureAD+ClemensNikolaus@CQ-Clemens'
        JOB_NAME = 'docker-test'
        SSL_EMAIL= 'clemens.nikolaus@comquent.de'
    }
    stages {
        stage('Setup Environment') {
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: 'SSH_PRIVATE_KEY', keyFileVariable: 'SSH_KEY_FILE'), 
                usernamePassword(credentialsId: 'JENKINS_ADMIN_CREDENTIALS', usernameVariable: 'JENKINS_USER', passwordVariable: 'JENKINS_PASS')
                ]) {
                    sh '''
                        set -e
                        echo "set up the environment"
                        chmod 600 $SSH_KEY_FILE
                        export SSH_PRIVATE_KEY=$(cat $SSH_KEY_FILE)
                        pip install -e .
                        python scripts/create_environment.py --config-repo https://github.com/cqNikolaus/jenkins_configs.git --branch bootstrap
                    '''
                }
            }
        }
    }
}
